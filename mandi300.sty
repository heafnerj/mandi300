%%
%% This is file `mandi.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% mandi.dtx  (with options: `package')
%% 
%% Copyright (C) 2020 by Paul J. Heafner <heafnerj@gmail.com>
%% ---------------------------------------------------------------------------
%% This  work may be  distributed and/or modified  under the conditions of the
%% LaTeX Project Public  License, either  version 1.3  of this  license or (at
%% your option) any later version. The latest version of this license is in
%%            http://www.latex-project.org/lppl.txt
%% and  version 1.3 or  later is  part of  all distributions of  LaTeX version
%% 2005/12/01 or later.
%% 
%% This work has the LPPL maintenance status `maintained'.
%% 
%% The Current Maintainer of this work is Paul J. Heafner.
%% 
%%  This work consists of the files mandi.dtx
%%                                  mandi.ins
%%                                  mandi.pdf
%%                                  README
%% 
%%  and includes the derived files  mandi.sty
%%                                  vdemo.py.
%% ---------------------------------------------------------------------------
%% 
%  NOTE: THE NUMBERS WILL NOT BE IN THE FINAL PACKAGE NAME!
\ProvidesPackage{mandi300}[2020/11/26 v3.0.0 Macros for physics and astronomy]
\NeedsTeXFormat{LaTeX2e}[1999/12/01]

% Package Version
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\mandiversion}{v3.0.0alpha dated 2020/11/26}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Fonts and ISO 80000-2 Notation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% unicode-math loads fontspec and xparse
\RequirePackage{unicode-math}
\unimathsetup{math-style=ISO}
\setmathfont[Scale=MatchLowercase]{TeX Gyre DejaVu Math} % Good g everywhere. Based on Arev.
% Borrow \mathscr and \mathbfscr from XITS Math
%  See https://tex.stackexchange.com/a/120073/218142
\setmathfont[Scale=MatchLowercase,range={\mathscr,\mathbfscr}]{XITS Math}
% Get original and bold \mathcal font
%  See https://tex.stackexchange.com/a/21742/218142
\setmathfont[Scale=MatchLowercase,range={\mathcal,\mathbfcal},StylisticSet=1]{XITS Math}
% Borrow Greek letters from Latin Modern Math
\setmathfont[Scale=MatchLowercase,range=    it/{greek,Greek}]{Latin Modern Math}
\setmathfont[Scale=MatchLowercase,range=  bfit/{greek,Greek}]{Latin Modern Math}
\setmathfont[Scale=MatchLowercase,range=    up/{greek,Greek}]{Latin Modern Math}
\setmathfont[Scale=MatchLowercase,range=  bfup/{greek,Greek}]{Latin Modern Math}
\setmathfont[Scale=MatchLowercase,range=bfsfup/{greek,Greek}]{Latin Modern Math}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Third Party Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{amsmath}                   % AMS goodness (don't load amssymb or amsfonts)
\RequirePackage{eso-pic}                   % needed for \hilite
\RequirePackage[g]{esvect}                 % needed for nice vector arrow, style g
\RequirePackage{kvoptions}                 % needed for keyvals
\SetupKeyvalOptions{%
  family=mi,%
  prefix=mi@%
}%
\RequirePackage{listings}                  % needed for program listings
\RequirePackage{makebox}                   % needed for consistent \dirvect; \makebox
\RequirePackage{mathtools}                 % needed for paired delimiters; extends amsmath
\RequirePackage{nicematrix}                % needed for column and row vectors
\RequirePackage{realboxes}                 % needed for coloring inline listings; \Colorbox
\RequirePackage{tensor}                    % needed for index notation
\RequirePackage{tikz}                      % needed for \hilite
\usetikzlibrary{shapes,fit,tikzmark}
\RequirePackage{xargs}                     % needed for the unit engine; \newcommandx
\RequirePackage{hyperref}                  % load last
% xcolor                                   % loaded by listings
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% We need to tweak the esvect fonts to get the correct font size.
%  Code provided by @egreg.
%  See https://tex.stackexchange.com/a/566676
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DeclareFontFamily{U}{esvect}{}
\DeclareFontShape{U}{esvect}{m}{n}{%
  <-5.5> vect5
  <5.5-6.5> vect6
  <6.5-7.5> vect7
  <7.5-8.5> vect8
  <8.5-9.5> vect9
  <9.5-> vect10
}{}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Package mandi Options
%  There aren't as many as before because of ISO 80000-2 notation.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DeclareBoolOption[false]{baseunits}
\DeclareBoolOption[false]{alternateunits}
\ProcessKeyvalOptions*

\newcommand*{\mandisetup}{%
  \kvsetkeys{mi}%
}%

\AtBeginDocument{%
  \ifmi@baseunits
    \def\unitmessage{mandi: You'll get base units.}
    \perpusebaseunit
  \else
    \ifmi@alternateunits
      \def\unitmessage{mandi: You'll get alternate units.}
      \perpusealternateunit
    \else
      \def\unitmessage{mandi: You'll get derived units.}
      \perpusederivedunit
    \fi  
  \fi
}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Standard Package Messages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\AtBeginDocument{%
\typeout{}
\typeout{mandi: You're using mandi version \mandiversion.}
\typeout{\unitmessage}
\typeout{}
}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% GlowScript and VPython Code Listings
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% We want to highlight numbers.
%  Based on a solution by Ulrike Fischer.
%  See https://tex.stackexchange.com/a/570717/218142
\directlua{%
 luaotfload.add_colorscheme("colordigits",
   {["8000FF"] = {"one","two","three","four","five","six","seven","eight","nine","zero"}})
}%
\newfontfamily\colordigits{DejaVuSansMono}[RawFeature={color=colordigits}]

%  See https://tex.stackexchange.com/a/529421/218142
\newfontfamily{\gsfontfamily}{DejaVuSansMono}    % new font for listings
\definecolor{gsbggray}     {rgb}{0.90,0.90,0.90} % background gray
\definecolor{gsgray}       {rgb}{0.30,0.30,0.30} % gray
\definecolor{gsgreen}      {rgb}{0.00,0.60,0.00} % green
\definecolor{gsorange}     {rgb}{0.80,0.45,0.12} % orange
\definecolor{gspeach}      {rgb}{1.00,0.90,0.71} % peach
\definecolor{gspearl}      {rgb}{0.94,0.92,0.84} % pearl
\definecolor{gsplum}       {rgb}{0.74,0.46,0.70} % plum
\lstdefinestyle{vpython}{%                       % style for listings
  backgroundcolor=\color{gsbggray},%             % background color
  basicstyle=\colordigits\footnotesize,%         % default style
  breakatwhitespace=true%                        % break at whitespace
  breaklines=true,%                              % break long lines
  captionpos=b,%                                 % position caption
  classoffset=1,%                                % STILL DON'T UNDERSTAND THIS
  commentstyle=\color{gsgray},%                  % font for comments
  deletekeywords={print},%                       % delete keywords from the given language
  emph={self,cls,@classmethod,@property},%       % words to emphasize
  emphstyle=\color{gsorange}\itshape,%           % font for emphasis
  escapeinside={(*@}{@*)},%                      % add LaTeX within your code
  frame=tb,%                                     % frame style
  framerule=2.0pt,%                              % frame thickness
  framexleftmargin=5pt,%                         % extra frame left margin
  %identifierstyle=\sffamily,%                    % style for identifiers
  keywordstyle=\gsfontfamily\color{gsplum},%     % color for keywords
  language=Python,%                              % select language
  linewidth=\linewidth,%                         % width of listings
  morekeywords={%                                % VPython/GlowScript specific keywords
    __future__,abs,acos,align,ambient,angle,append,append_to_caption,%
    append_to_title,arange,arrow,asin,astuple,atan,atan2,attach_arrow,%
    attach_trail,autoscale,axis,background,billboard,bind,black,blue,border,%
    bounding_box,box,bumpaxis,bumpmap,bumpmaps,camera,canvas,caption,capture,%
    ceil,center,clear,clear_trail,click,clone,CoffeeScript,coils,color,combin,%
    comp,compound,cone,convex,cos,cross,curve,cyan,cylinder,data,degrees,del,%
    delete,depth,descender,diff_angle,digits,division,dot,draw_complete,%
    ellipsoid,emissive,end_face_color,equals,explog,extrusion,faces,factorial,%
    False,floor,follow,font,format,forward,fov,frame,gcurve,gdisplay,gdots,%
    get_library,get_selected,ghbars,global,GlowScript,graph,graphs,green,gvbars,%
    hat,headlength,headwidth,height,helix,hsv_to_rgb,index,interval,keydown,%
    keyup,label,length,lights,line,linecolor,linewidth,logx,logy,lower_left,%
    lower_right,mag,mag2,magenta,make_trail,marker_color,markers,material,%
    max,min,mouse,mousedown,mousemove,mouseup,newball,norm,normal,objects,%
    offset,one,opacity,orange,origin,path,pause,pi,pixel_to_world,pixels,plot,%
    points,pos,pow,pps,print,print_function,print_options,proj,purple,pyramid,%
    quad,radians,radius,random,rate,ray,read_local_file,readonly,red,redraw,%
    retain,rgb_to_hsv,ring,rotate,round,scene,scroll,shaftwidth,shape,shapes,%
    shininess,show_end_face,show_start_face,sign,sin,size,size_units,sleep,%
    smooth,space,sphere,sqrt,start,start_face_color,stop,tan,text,textpos,%
    texture,textures,thickness,title,trail_color,trail_object,trail_radius,%
    trail_type,triangle,trigger,True,twist,unbind,up,upper_left,upper_right,%
    userpan,userspin,userzoom,vec,vector,vertex,vertical_spacing,visible,%
    visual,vpython,VPython,waitfor,white,width,world,xtitle,yellow,yoffset,%
    ytitle%
  },%
  morekeywords={print,None,TypeError},%          % additional keywords
  morestring=[b]{"""},%                          % treat triple quotes as strings
  numbers=left,%                                 % where to put line numbers
  numbersep=10pt,%                               % how far line numbers are from code
  numberstyle=\bfseries\tiny,%                   % set to 'none' for no line numbers
  showstringspaces=false,%                       % show spaces in strings
  showtabs=false,%                               % show tabs within strings
  stringstyle=\gsfontfamily\color{gsgreen},%     % color for strings
  upquote=true,%                                 % how to typeset quotes
}%
% A new, more intelligent glowscriptblock environment.
%  Code provided by Ulrich Diez.
%  See https://tex.stackexchange.com/a/565167/218142
%  To display a VPython program, omit the optional link.
\makeatletter
% Infrastructure for "hyperref-normalizing" an optional argument of a \lstnewenvironment:
\begingroup
  \catcode`\^^A=14 %
  \catcode`\^^M\active^^A
  \catcode`\%\active^^A
  \@ifdefinable\hyper@@normaliseoptarg{^^A
    \gdef\hyper@@normaliseoptarg#1#2#3]{^^A
      \edef\Hy@tempa{^^A
        \endgroup\noexpand#1[{\Hy@RemovePercentCr#3%^^M\@nil}]^^A
      }^^A
      \Hy@tempa^^A
    }^^A
  }^^A
\endgroup
\newcommand\MY@exchange[2]{#2#1}%
\expandafter\newcommand\expandafter*\expandafter\hyper@normaliseoptarg\expandafter{%
  \romannumeral0%
  \expandafter\MY@exchange\expandafter{\hyper@normalise}{%
    \@firstofone{\expandafter} %
    \MY@exchange{\let\hyper@@normalise=\hyper@@normaliseoptarg}%
  }%
}%
\newcommand\lstenv@testhyper@normalizeopt[2]{%
  \@ifnextchar[{\catcode \active 5\relax\hyper@normaliseoptarg{\lstenv@testopt\noexpand#1{#2}}}%
               {\hyper@normaliseoptarg{#1}[{#2}]}%
}%
% end of Infrastructure for "hyperref-normalizing" an optional argument of a \lstnewenvironment.

\newsavebox\glowscriptblockTempBox
\newcommand\glowscriptblockURL{}%
\newcommand\glowscriptblockWrapInPartopsep[1]{%
   \vskip\partopsep#1\vskip\partopsep
}%
\lstnewenvironment{glowscriptblock}[3][]{%
  \newpage % Each listing begins on a new page.
  \gdef\glowscriptblockURL{#1}%
  \setbox\glowscriptblockTempBox\hbox{\begingroup\aftergroup}%
  \lstset{style=vpython,caption={#2},label={#3}}%
}{%
  \endgroup
  \ifx\glowscriptblockURL\empty\else\hypersetup{hidelinks}\fi
  \ifvmode\endgraf\expandafter\glowscriptblockWrapInPartopsep\else\endgraf\expandafter\@firstofone\fi
  {%
    \vskip\topsep
    \noindent
    \ifcat $\detokenize\expandafter\expandafter\expandafter{\expandafter\@firstoftwo\glowscriptblockURL{}.}$%
    \expandafter\@firstoftwo\else\expandafter\@secondoftwo\fi
    {\@firstofone}%
    {\expandafter\href\expandafter{\glowscriptblockURL}}%
    {\usebox{\glowscriptblockTempBox}}%
    \endgraf
    \vskip\topsep
  }%
}%
% Make sure hyperref's \href gets its argument "hyperref-normalized" by replacing
% \lstenv@testopt with \lstenv@testhyper@normalizeopt in the definition of \glowscriptblock@.
\expandafter\renewcommand\expandafter*\expandafter\glowscriptblock@\expandafter{%
  \romannumeral0%
  \expandafter\MY@exchange\expandafter{%
    \csname\string\glowscriptblock@\endcsname{}%<-the default for the opt arg is between these braces. 
                                               %The default is empty.
  }{%
    \ifx\protect\@typeset@protect
      \expandafter\lstenv@testhyper@normalizeopt
    \else
      \@x@protect\glowscriptblock@ 
    \fi
  }%
}%
\makeatother
% Creating aliases for environment is generally not thought to be a good idea, so I won't
% create a vpythonblock alias for glowscriptblock. Just omit the optional parameter for 
% typesetting a VPython block of code.

% GlowScript inline. Listing should be shorter than one line.
%  See https://tex.stackexchange.com/q/408878/218142
\newcommand*{\glowscriptline}[1]{\Colorbox{gsbggray}{\lstinline[style=vpython]{#1}}}
% An alias.
\newcommand*{\vpythonline}{\glowscriptline}

% VPython file input.
%  There's no semantic need for an alias since GlowScript programs aren't saved locally.
\newcommand*{\vpythonfile}[3]{%
  \newpage % Each listing begins on a new page.
  \lstinputlisting[style=vpython,caption={#1},label={#2}]{#3}
}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Unit Engine
%  All single letter macros are gone. I basically absorbed and
%   adapted the now defunct SIunits package.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\per}{\ensuremath{/}}
\newcommand*{\usk}{\ensuremath{\cdot}}
\newcommand*{\unit}[2]{\ensuremath{{#1}\;{#2}}}
\newcommand*{\ampere}{\ensuremath{\symup{A}}}
\newcommand*{\arcminute}{\ensuremath{'}}
\newcommand*{\arcsecond}{\ensuremath{''}}
\newcommand*{\atomicmassunit}{\ensuremath{\symup{u}}}
\newcommand*{\candela}{\ensuremath{\symup{cd}}}
\newcommand*{\coulomb}{\ensuremath{\symup{C}}}
\newcommand*{\degree}{\ensuremath{^{\circ}}}
\newcommand*{\electronvolt}{\ensuremath{\symup{eV}}}
\newcommand*{\farad}{\ensuremath{\symup{F}}}
\newcommand*{\henry}{\ensuremath{\symup{H}}}
\newcommand*{\hertz}{\ensuremath{\symup{Hz}}}
\newcommand*{\hour}{\ensuremath{\symup{h}}}
\newcommand*{\joule}{\ensuremath{\symup{J}}}
\newcommand*{\kelvin}{\ensuremath{\symup{K}}}
\newcommand*{\kilogram}{\ensuremath{\symup{kg}}}
\newcommand*{\meter}{\ensuremath{\symup{m}}}
\newcommand*{\minute}{\ensuremath{\symup{min}}}
\newcommand*{\mole}{\ensuremath{\symup{mol}}}
\newcommand*{\newton}{\ensuremath{\symup{N}}}
\newcommand*{\ohm}{\ensuremath{\symup\Omega}}
\newcommand*{\pascal}{\ensuremath{\symup{Pa}}}
\newcommand*{\radian}{\ensuremath{\symup{rad}}}
\newcommand*{\second}{\ensuremath{\symup{s}}}
\newcommand*{\siemens}{\ensuremath{\symup{S}}}
\newcommand*{\steradian}{\ensuremath{\symup{sr}}}
\newcommand*{\tesla}{\ensuremath{\symup{T}}}
\newcommand*{\volt}{\ensuremath{\symup{V}}}
\newcommand*{\watt}{\ensuremath{\symup{W}}}
\newcommand*{\weber}{\ensuremath{\symup{Wb}}}
\newcommand*{\square}[1]{\ensuremath{{#1}^2}}               % prefix   2
\newcommand*{\cubic}[1]{\ensuremath{{#1}^3}}                % prefix   3
\newcommand*{\quartic}[1]{\ensuremath{{#1}^4}}              % prefix   4
\newcommand*{\reciprocal}[1]{\ensuremath{{#1}^{-1}}}        % prefix  -1
\newcommand*{\reciprocalsquare}[1]{\ensuremath{{#1}^{-2}}}  % prefix  -2
\newcommand*{\reciprocalcubic}[1]{\ensuremath{{#1}^{-3}}}   % prefix  -3
\newcommand*{\reciprocalquartic}[1]{\ensuremath{{#1}^{-4}}} % prefix  -4
\newcommand*{\squared}{\ensuremath{^2}}                     % postfix  2
\newcommand*{\cubed}{\ensuremath{^3}}                       % postfix  3
\newcommand*{\quarted}{\ensuremath{^4}}                     % postfix  4
\newcommand*{\reciprocaled}{\ensuremath{^{-1}}}             % postfix -1
\newcommand*{\reciprocalsquared}{\ensuremath{^{-2}}}        % postfix -2
\newcommand*{\reciprocalcubed}{\ensuremath{^{-3}}}          % postfix -3
\newcommand*{\reciprocalquarted}{\ensuremath{^{-4}}}        % postfix -4
\newcommand*{\emptyunit}{\ensuremath{\mdlgwhtsquare}}
%  This is the actual unit engine that lets mandi "know" the unit of every
%   physical quantity we define.
%   Code provided by Ulrich Diez.
%%---------------------------------------------------------------
%% Input:   \Name <non embraced-tokens>{ControlSequenceName}
%% yields:  <non embraced-tokens>\ControlSequenceName
%% whereby <non embraced-tokens> can be empty
%% or can be something like \newcommand or \renewcommand or \long\def
%% or whatsoever.
%%%...............................................................
\newcommand*\ExchangeArgs[2]{#2#1}%
\newcommand*\Name{}%
\long\def\Name#1#{\romannumeral0\InnerName{#1}}%
\newcommand*\InnerName[2]{%
  \expandafter\ExchangeArgs\expandafter{\csname#2\endcsname}{#1}
}%
%%---------------------------------------------------------------
%% \Forkifnull - Macro to check if argument doesn't contain any
%%               token/is empty/is null:
%% \Forkifnull{<tokens>}%
%%            {<action if <tokens>-Arg is empty/null>}%
%%            {<action if <tokens>-Arg contains tokens}
%%...............................................................
\begingroup %<-keep \makeatletter "local"/restricted to a new current scope.
            % The scope will be closed and thus one will return to the
            % usual catcode-régime when - right after reading and tokenizing
            % it under @-other-catcode-régime - \@firstofone "spits out"
            % its argument whose first token will be \endgroup:
\makeatletter
\@firstofone{%
  \endgroup
  \newcommand*\Forkifnull[3]{%
    \romannumeral\iffalse{\fi\expandafter\@secondoftwo\expandafter%
    {\expandafter{\string#1}\expandafter\@secondoftwo\string}%
    \expandafter\@firstoftwo\expandafter{\iffalse}\fi0 #3}{0 #2}%
  }%
}%
%%---------------------------------------------------------------
%% Selecting appropriate unit-component from data-array:
%%...............................................................
% It is assumed that units come from an array
% consisting of three components/elements/_macro-arguments:
%  {<base unit>}%
%  {<derived unit>}%
%  {<traditional unit>}%
% Thus the "unit-selecting"-macros need to get either the first or the second
% or the third argument of three arguments;
\newcommand*\selectbaseunit[3]{#1}
\newcommand*\selectderivedunit[3]{#2}
\newcommand*\selectalternativeunit[3]{#3}
% \selectunit will select the unit and when doing so, it will
% be redefined via \let to equal either \selectbaseunit or
% \selectderivedunit or \selectalternateunit or \selectmathsymbol:
\newcommand*\selectunit{}
% "Switches" to "tell"  \selectunit which sort of unit to select:
\newcommand*\perpusebaseunit{\let\selectunit=\selectbaseunit}
\newcommand*\perpusederivedunit{\let\selectunit=\selectderivedunit}
\newcommand*\perpusealternativeunit{\let\selectunit=\selectalternativeunit}
% Localized variants of the unit selectors:
\newcommand*\hereusebaseunit[1]{\begingroup\perpusebaseunit#1\endgroup}%
\newcommand*\hereusederivedunit[1]{\begingroup\perpusederivedunit#1\endgroup}%
\newcommand*\hereusealternativeunit[1]{\begingroup\perpusealternativeunit#1\endgroup}%
% Environment variants of the unit-selectors:
\newenvironment{usebaseunit}{\perpusebaseunit}{}%
\newenvironment{usederivedunit}{\perpusederivedunit}{}%
\newenvironment{usealternativeunit}{\perpusealternativeunit}{}%
% Defining a new physical quantity.
\newcommand*\newphysicsquantity{\definephysicsquantity{\newcommand}}
\newcommand*\redefinephysicsquantity{\definephysicsquantity{\renewcommand}}
\newcommandx*\definephysicsquantity[5][4=,5=]{%
  \innerdefineWhatsoeverQuantityFork{#3}{#4}{#5}{#1}{#2}{}{[1]}{##1}%
}%
% Defining a new physical constant
\newcommand*\newphysicsconstant{\definephysicsconstant{\newcommand}}
\newcommand*\redefinephysicsconstant{\definephysicsconstant{\renewcommand}}
\newcommandx*\definephysicsconstant[7][6=,7=]{%
  \innerdefineWhatsoeverQuantityFork{#5}{#6}{#7}{#1}{#2}{#3}{}{#4}%
}%
% Internal macros for defining quantities and constants.
\newcommand*\innerdefineWhatsoeverQuantityFork[3]{%
  \expandafter\innerdefineWhatsoeverQuantity\romannumeral0%
  \Forkifnull{#3}{\Forkifnull{#2}{{#1}}{{#2}}{#1}}{\Forkifnull{#2}{{#1}}{{#2}}{#3}}{#1}%
}%
\newcommand*\innerdefineWhatsoeverQuantity[8]{%
  \Name#4{#5}#7{\unit{#8}{\selectunit{#3}{#1}{#2}}}%
  \Name#4{#5baseunit}#7{\unit{#8}{#3}}%
  \Name#4{#5derivedunit}#7{\unit{#8}{#1}}%
  \Name#4{#5alternativeunit}#7{\unit{#8}{#2}}%
  \Name#4{#5onlyunit}{\selectunit{#3}{#1}{#2}}%
  \Name#4{#5onlybaseunit}{\ensuremath{#3}}%
  \Name#4{#5onlyderivedunit}{\ensuremath{#1}}%
  \Name#4{#5onlyalternativeunit}{\ensuremath{#2}}%
  \Name#4{#5value}#7{\ensuremath{#8}}%
  \Forkifnull{#7}{%
    \ifx#4\renewcommand\Name\let{#5mathsymbol}=\relax\fi
    \Name\newcommand*{#5mathsymbol}{\ensuremath{#6}}}{}}%
\makeatother
%  Define every quantity we need in introductory physics.
\newphysicsquantity{displacement}%
  {\meter}%
  [\meter]%
  [\meter]%
\newphysicsquantity{mass}%
  {\kilogram}%
  [\kilogram]%
  [\kilogram]
\newphysicsquantity{duration}%
  {\second}%
  [\second]%
  [\second]
\newphysicsquantity{current}%
  {\ampere}%
  [\ampere]%
  [\ampere]%
\newphysicsquantity{temperature}%
  {\kelvin}%
  [\kelvin]%
  [\kelvin]%
\newphysicsquantity{amount}%
  {\mole}%
  [\mole]%
  [\mole]%
\newphysicsquantity{luminous}%
  {\candela}%
  [\candela]%
  [\candela]%
\newphysicsquantity{momentum}%
  {\meter\usk\kilogram\usk\reciprocal\second}%
  [\newton\usk\second]%
  [\kilogram\usk\meter\per\second]%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Highlighting in mathematical expressions.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcounter{tikzhighlightnode}
\NewDocumentCommand{\hilite}{ O{magenta!60} m O{rectangle} }{%
  % Original code by anonymous user abcdefg, modified by me.
  % See https://texample.net/tikz/examples/beamer-arrows/
  % See also https://tex.stackexchange.com/a/406084/218142
  % See also https://tex.stackexchange.com/a/570858/218142
  % See also https://tex.stackexchange.com/a/570789/218142
  % See also https://tex.stackexchange.com/a/79659/218142
  % See also https://tex.stackexchange.com/q/375032/218142
  % See also https://tex.stackexchange.com/a/571744/218142
  \stepcounter{tikzhighlightnode}%
  \tikzmarknode{highlighted-node-\number\value{tikzhighlightnode}}{#2}%
  \edef\temp{%
    \noexpand\AddToShipoutPictureBG{%
      \noexpand\begin{tikzpicture}[overlay,remember picture]%
      \noexpand\iftikzmarkoncurrentpage{highlighted-node-\number\value{tikzhighlightnode}}%
       \noexpand\node[inner sep=1.0pt,fill=#1,#3,fit=(highlighted-node-\number\value{tikzhighlightnode})]{};%
      \noexpand\fi
      \noexpand\end{tikzpicture}%
    }%
  }%
  \temp%
}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Intelligent delimiters provided via the mathtools package.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Use starred version for fractions. Can also take optional sizes.
\DeclarePairedDelimiterX{\norm}[1]{\lVert}{\rVert}{\ifblank{#1}{\:\cdot\:}{#1}}
\DeclarePairedDelimiterX{\absv}[1]{\lvert}{\rvert}{\ifblank{#1}{\:\cdot\:}{#1}}
\DeclarePairedDelimiterX{\angs}[1]{\langle}{\rangle}{\ifblank{#1}{\:\cdot\:}{#1}}
\DeclarePairedDelimiterX{\pens}[1]{(}{)}{\ifblank{#1}{\:\cdot\:}{#1}}
\DeclarePairedDelimiterX{\dims}[1]{[}{]}{\ifblank{#1}{\:\cdot\:}{#1}}
\DeclarePairedDelimiterX{\unts}[1]{\{}{\}}{\ifblank{#1}{\:\cdot\:}{#1}}

% These are revised.
\NewDocumentCommand{\innorm}{ O{\:\cdot\:} }{%
  \left\lVert#1\right\rVert
}%
\NewDocumentCommand{\inabsv}{ O{\:\cdot\:} }{%
  \left\lvert#1\right\rvert
}%
\NewDocumentCommand{\inangs}{ O{\:\cdot\:} }{%
  \left\langle#1\right\rangle
}%
\NewDocumentCommand{\inpens}{ O{\:\cdot\:} }{%
  \left(#1\right)
}%
\NewDocumentCommand{\indims}{ O{\:\cdot\:} }{%
  \left[#1\right]
}%
\NewDocumentCommand{\inunts}{ O{\:\cdot\:} }{%
  \left\{#1\right\}
}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Declare some new math operators.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \dim operator is already defined in amsmath.
\DeclareMathOperator{\abs}{abs}
\DeclareMathOperator{\units}{units}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Redefine some commands to account for index notation.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% We need some good semantic commands to distinguish index notation
%  from coordinate free notation. These are experimental.
%  Use starred form for index notation, regular form for coordinate-free.
\NewDocumentCommand{\veccomp}{ s m }{%
  % Consider renaming this to \vectorsym.
  \IfBooleanTF{#1}
  {% We have a *.
    \ensuremath{\symnormal{#2}}%
  }%
  {% We don't have a *.
    \ensuremath{\symbfit{#2}}%
  }%
}%
\NewDocumentCommand{\tencomp}{ s m }{%
  % Consider renaming this to \tensororsym.
  \IfBooleanTF{#1}
  {% We have a *.
    \ensuremath{\symsfit{#2}}%
  }%
  {% We don't have a *.
    \ensuremath{\symbfsfit{#2}}%
  }%
}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% We need some custom commands for coordinate-free tensors.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% This is an intelligent slot command for coordinate-free tensor notation.
%  \newcommand*{\slot}[1][~]{\,\underline{\smash{\makebox[1.5em]{\ensuremath{#1}}}}\,}
%  \slot       gives just a blank slot 1.0em wide.
%  \slot[...]  fills the slot with a vector but doesn't show the slot.
%  \slot*[...] fills the slot but does show the slot.
%  \slot*      isn't defined and shouldn't be used even though it doesn't 
%               throw an error.
\NewDocumentCommand{\slot}{ s d[] }{%
  % d[] must be used because of the way consecutive optional
  %  arguments are handled. See xparse docs for details.
  \IfBooleanTF{#1}
  {% We have a *.
    \IfValueT{#2}
    {% Insert a vector, and show the slot.
      \underline{\smash{\makebox[1.5em]{\ensuremath{#2}}}}
    }%
  }%
  {% We don't have a *.
    \IfValueTF{#2}
    {% Insert a vector, but don't show the slot.
      \smash{\makebox[1.5em]{\ensuremath{#2}}}
    }%
    {% No vector; just show the slot.
      \underline{\smash{\makebox[1.5em]{\ensuremath{}}}}
    }%
  }%
}%

% Notation for contraction on pairs of slots.
%\newcommand*{\contraction}[1]{\mathbbmss{C}_{#1}}
%\newcommand*{\contraction}[1]{C_{#1}}
\NewDocumentCommand{\contraction}{ s m }{%
  \IfBooleanTF{#1}
  {\mathsf{C}}% We have a *.
  {\symbb{C}}% We don't have a *.
  _{#2}
}%
%\NewDocumentCommand{\contraction}{ s m }{%
%  \IfBooleanTF {#1} % check for *
%  {% Use C for contraction.
%    \mathsf{C}_{#2}
%  }%
%  {%
%    \symbb{C}_{#2}
%  }%  
%}%

% An intelligent exterior derivative operator.
\NewDocumentCommand{\dd}{ s }{%
  \mathop{}\!
  \IfBooleanTF{#1}
  {\symbfsfup{d}}% We have a *.
  {\symsfup{d}}% We don't have a *.
}%
%\NewDocumentCommand{\dd}{ s }{%
%  \IfBooleanTF{#1}
%  {% We have a *.
%    \mathop{}\!\symbfsfup{d}
%  }%
%  {% We don't have a *.
%    \mathop{}\!\symsfup{d}
%  }%
%}%

% The zero vector.
\DeclareRobustCommand{\zerovector}{\symbfup{0}}

% Notation for tensor valence.
%  \binom looks terrible in inline math!
%  See https://tex.stackexchange.com/q/269980/218142
%\newcommand*{\valence}[2]{\ensuremath{\binom{#1}{#2}}}
%  Works, but still sucks.
\newcommand*{\valence}[2]{\ensuremath{\Bigl(\genfrac{}{}{0pt}{}{#1}{#2}\Bigr)}}
%  Switch to horizontal.
%\newcommand*{\valence}[2]{\ensuremath{(#1,#2)}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Column and Row Vectors
%  See https://tex.stackexchange.com/a/39054/218142
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ExplSyntaxOn
\NewDocumentCommand{\colvec}{ O{,} m }{%
  \vector_main:nnnn { p } { \\ } { #1 } { #2 }
}%

\NewDocumentCommand{\rowvec}{ O{,} m }{%
  \vector_main:nnnn { p } { & } { #1 } { #2 }
}%

\seq_new:N \l__vector_arg_seq
\cs_new_protected:Npn \vector_main:nnnn #1 #2 #3 #4 {%
  \seq_set_split:Nnn \l__vector_arg_seq { #3 } { #4 }
  \begin{#1NiceMatrix}[r]
    \seq_use:Nnnn \l__vector_arg_seq { #2 } { #2 } { #2 }
  \end{#1NiceMatrix}
}%
\ExplSyntaxOff
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Intelligent Coordinate-Free \vec Command.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Why doesn't it work when I put spaces around #3 or #4?
%  Because outside of \ExplSyntaxOn...\ExplSyntaxOff, 
%  the _ character has a different catcode.
%  See https://tex.stackexchange.com/q/554706/218142
%  Also see https://tex.stackexchange.com/a/531037/218142
%  This needs to incorporate ISO 80000-2.
\RenewDocumentCommand{\vec}{ s m e{_^} }{%
  \ensuremath{%
    % Note the \, used to make superscript look better.
    \IfBooleanTF {#1}        % check for *
      {\vv{#2}%  % * gives an arrow
         % Use \sp{} primitive for superscript.
         % Adjust superscript for the arrow.
         \sp{\IfValueT{#4}{\,#4}\vphantom{\smash[t]{\big|}}}
      }%         
      {\symbfit{#2}  % no * gives us bold
         % Use \sp{} primitive for superscript.
         % No superscript adjustment needed.
         \sp{\IfValueT{#4}{#4}\vphantom{\smash[t]{\big|}}}
      }% 
    % Use \sb{} primitive for subscript.
    \sb{\IfValueT{#3}{#3}\vphantom{\smash[b]{|}}}
  }%
}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Symbolic vector commands.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NewDocumentCommand{\Dvect}{ s m }{%
  \Delta
  \IfBooleanTF{#1}
    {\vec*}%
    {\vec}%
  {#2}
}%
\NewDocumentCommand{\dirvect}{ s m }{%
  % A slight tweak is needed to get uniform hats.
  % Requires the makebox package.
  %  See https://tex.stackexchange.com/a/391204/218142
  \widehat{\makebox*{\(p\)}{%
    \ensuremath{%
      \IfBooleanTF{#1}%
        {#2}%
        {\symbfit{#2}}%
      }%
    }%
  }%
}%
\NewDocumentCommand{\magvect}{ s m }{%
  \norm{%
    \IfBooleanTF{#1}
      {\vec*}%
      {\vec}%
    {#2}
  }%
}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Other Commands.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\changein}{\Delta}
% See https://tex.stackexchange.com/q/570223/218142
\newcommand*{\reason}[2][4cm]{&&\begin{minipage}{#1}\raggedright\small #2\end{minipage}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\endinput
%%
%% End of file `mandi.sty'.
